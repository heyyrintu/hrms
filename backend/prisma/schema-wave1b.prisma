// Wave 1B Models - to be appended to schema.prisma

// ============================================
// LETTER TEMPLATES
// ============================================

enum LetterType {
  OFFER_LETTER
  APPOINTMENT_LETTER
  INCREMENT_LETTER
  CONFIRMATION_LETTER
  RELIEVING_LETTER
  EXPERIENCE_LETTER
  TRANSFER_LETTER
  PROMOTION_LETTER
  WARNING_LETTER
  TERMINATION_LETTER
  OTHER
}

model LetterTemplate {
  id          String     @id @default(uuid())
  tenantId    String
  name        String
  type        LetterType
  content     String     @db.Text  // HTML with {{placeholders}}
  description String?
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relations
  tenant            Tenant            @relation(fields: [tenantId], references: [id])
  lettersGenerated  LetterGenerated[]

  @@index([tenantId])
  @@index([type])
  @@map("letter_templates")
}

model LetterGenerated {
  id         String   @id @default(uuid())
  tenantId   String
  templateId String
  employeeId String
  content    String   @db.Text  // Final HTML with values replaced
  generatedBy String  // userId who generated it
  generatedAt DateTime @default(now())

  // Relations
  tenant   Tenant          @relation(fields: [tenantId], references: [id])
  template LetterTemplate  @relation(fields: [templateId], references: [id])
  employee Employee        @relation(fields: [employeeId], references: [id])

  @@index([tenantId])
  @@index([employeeId])
  @@map("letters_generated")
}

// ============================================
// CONTINUOUS FEEDBACK
// ============================================

enum FeedbackType {
  POSITIVE
  CONSTRUCTIVE
  GENERAL
}

enum FeedbackVisibility {
  PRIVATE           // Only sender and receiver
  VISIBLE_TO_MANAGER // Sender, receiver, and their managers
  PUBLIC            // Visible to all in org
}

model Feedback {
  id         String             @id @default(uuid())
  tenantId   String
  senderId   String
  receiverId String
  content    String             @db.Text
  type       FeedbackType
  visibility FeedbackVisibility @default(PRIVATE)
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt

  // Relations
  tenant   Tenant   @relation(fields: [tenantId], references: [id])
  sender   Employee @relation("FeedbackSender", fields: [senderId], references: [id])
  receiver Employee @relation("FeedbackReceiver", fields: [receiverId], references: [id])

  @@index([tenantId])
  @@index([receiverId])
  @@index([senderId])
  @@map("feedbacks")
}

// ============================================
// PERFORMANCE IMPROVEMENT PLAN (PIP)
// ============================================

enum PIPStatus {
  DRAFT
  ACTIVE
  COMPLETED
  EXTENDED
  TERMINATED
}

model ImprovementPlan {
  id           String     @id @default(uuid())
  tenantId     String
  employeeId   String
  managerId    String
  title        String
  description  String     @db.Text
  startDate    DateTime   @db.Date
  endDate      DateTime   @db.Date
  status       PIPStatus  @default(DRAFT)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  // Relations
  tenant   Tenant                  @relation(fields: [tenantId], references: [id])
  employee Employee                @relation("PIPEmployee", fields: [employeeId], references: [id])
  manager  Employee                @relation("PIPManager", fields: [managerId], references: [id])
  goals    ImprovementPlanGoal[]

  @@index([tenantId])
  @@index([employeeId])
  @@index([managerId])
  @@index([status])
  @@map("improvement_plans")
}

model ImprovementPlanGoal {
  id          String   @id @default(uuid())
  planId      String
  description String   @db.Text
  targetDate  DateTime @db.Date
  isCompleted Boolean  @default(false)
  completedAt DateTime?
  notes       String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  plan ImprovementPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@index([planId])
  @@map("improvement_plan_goals")
}

// ============================================
// WEBHOOKS
// ============================================

model Webhook {
  id          String   @id @default(uuid())
  tenantId    String
  url         String
  events      String[] // Array of event names like ["employee.created", "leave.approved"]
  secret      String?  // Optional HMAC secret for signature verification
  isActive    Boolean  @default(true)
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tenant Tenant       @relation(fields: [tenantId], references: [id])
  logs   WebhookLog[]

  @@index([tenantId])
  @@map("webhooks")
}

enum WebhookLogStatus {
  SUCCESS
  FAILED
  RETRYING
}

model WebhookLog {
  id            String           @id @default(uuid())
  tenantId      String
  webhookId     String
  event         String           // e.g., "employee.created"
  payload       Json
  status        WebhookLogStatus
  httpStatus    Int?
  responseBody  String?          @db.Text
  errorMessage  String?          @db.Text
  attemptCount  Int              @default(1)
  triggeredAt   DateTime         @default(now())

  // Relations
  tenant  Tenant  @relation(fields: [tenantId], references: [id])
  webhook Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([webhookId])
  @@index([triggeredAt])
  @@map("webhook_logs")
}
